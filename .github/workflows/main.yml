name: Tailscale Windows App Connector - Production Ready

on:
  workflow_dispatch:
    inputs:
      hostname:
        description: 'ğŸ”§ Device hostname prefix'
        required: false
        default: 'windows-app-runner'
        type: string
      rdp_port:
        description: 'ğŸ”Œ Custom RDP port (default: 3389)'
        required: false
        default: '3389'
        type: string
      enable_ssh:
        description: 'ğŸ”‘ Enable SSH access'
        required: false
        default: true
        type: boolean
      enable_exit_node:
        description: 'ğŸŒ Use as exit node'
        required: false
        default: false
        type: boolean
      advertise_routes:
        description: 'ğŸ“¡ Advertise network routes (e.g., 192.168.1.0/24)'
        required: false
        default: ''
        type: string
      enable_auto_recovery:
        description: 'ğŸ”„ Auto-recovery jika Tailscale mati'
        required: false
        default: true
        type: boolean
      recovery_interval:
        description: 'â±ï¸  Health check interval (detik)'
        required: false
        default: 60
        type: number
      session_duration:
        description: 'â³ Session duration (menit, 0 = 3 days)'
        required: false
        default: 0
        type: number

env:
  TAILSCALE_VERSION: "1.82.0"
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: ${{ github.event.inputs.session_duration == 0 && 4320 || github.event.inputs.session_duration }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Generate Secure Credentials
        id: credentials
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘          GENERATING SECURE RDP CREDENTIALS                  â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          
          # Generate random username dengan prefix Skyro
          $randomSuffix = -join ((65..90) + (97..122) | Get-Random -Count 8 | ForEach-Object {[char]$_})
          $username = "Skyro_$randomSuffix"
          
          # Generate strong password (18 karakter)
          Add-Type -AssemblyName System.Security
          $charSet = @{
              Upper   = [char[]](65..90)      # A-Z
              Lower   = [char[]](97..122)     # a-z
              Number  = [char[]](48..57)      # 0-9
              Special = [char[]](33..47) + [char[]](58..64) +
                        [char[]](91..96) + [char[]](123..126)
          }
          
          # Generate 18 karakter password
          $rawPassword = @()
          $rawPassword += $charSet.Upper | Get-Random -Count 5
          $rawPassword += $charSet.Lower | Get-Random -Count 5
          $rawPassword += $charSet.Number | Get-Random -Count 5
          $rawPassword += $charSet.Special | Get-Random -Count 3
          $password = -join ($rawPassword | Sort-Object { Get-Random })
          
          # Save to environment
          echo "RDP_USERNAME=$username" >> $env:GITHUB_ENV
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          
          Write-Host "âœ… Username: $username" -ForegroundColor Green
          Write-Host "âœ… Password: [GENERATED - LIHAT DI BAWAH]" -ForegroundColor Green
          Write-Host "`n" -ForegroundColor White

      - name: ğŸ–¥ï¸ Configure Advanced RDP Settings
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘          CONFIGURING REMOTE DESKTOP PROTOCOL                â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          
          $rdpPort = "${{ github.event.inputs.rdp_port || '3389' }}"
          
          try {
              # Enable Remote Desktop
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                              -Name "fDenyTSConnections" -Value 0 -Force -ErrorAction Stop
              Write-Host "âœ… Remote Desktop enabled" -ForegroundColor Green
              
              # Disable Network Level Authentication (for compatibility)
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                              -Name "UserAuthentication" -Value 0 -Force -ErrorAction Stop
              Write-Host "âœ… Network Level Authentication disabled" -ForegroundColor Green
              
              # Set custom port
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                              -Name "PortNumber" -Value $rdpPort -Force -ErrorAction Stop
              Write-Host "âœ… RDP Port set to: $rdpPort" -ForegroundColor Green
              
              # Configure firewall
              netsh advfirewall firewall delete rule name="RDP-Tailscale" 2>$null
              netsh advfirewall firewall add rule name="RDP-Tailscale" `
                  dir=in action=allow protocol=TCP localport=$rdpPort 2>$null
              Write-Host "âœ… Firewall rule added for port $rdpPort" -ForegroundColor Green
              
              # Restart RDP service
              Restart-Service -Name TermService -Force -ErrorAction Stop
              Write-Host "âœ… Remote Desktop service restarted" -ForegroundColor Green
          }
          catch {
              Write-Host "âš ï¸  Error configuring RDP: $_" -ForegroundColor Yellow
              Write-Host "   Continuing with default settings..." -ForegroundColor Yellow
          }
          
          Write-Host "`n" -ForegroundColor White

      - name: ğŸ‘¤ Create RDP User with Secure Password
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘          CREATING LOCAL RDP USER ACCOUNT                    â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          
          try {
              $securePass = ConvertTo-SecureString $env:RDP_PASSWORD -AsPlainText -Force
              
              # Create local user
              New-LocalUser -Name $env:RDP_USERNAME `
                           -Password $securePass `
                           -FullName "Tailscale RDP Access" `
                           -Description "Created by GitHub Actions - $(Get-Date)" `
                           -AccountNeverExpires `
                           -PasswordNeverExpires `
                           -ErrorAction Stop
              Write-Host "âœ… User created: $env:RDP_USERNAME" -ForegroundColor Green
              
              # Add to groups
              Add-LocalGroupMember -Group "Administrators" -Member $env:RDP_USERNAME -ErrorAction Stop
              Write-Host "âœ… Added to Administrators group" -ForegroundColor Green
              
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:RDP_USERNAME -ErrorAction Stop
              Write-Host "âœ… Added to Remote Desktop Users group" -ForegroundColor Green
              
              # Verify user creation
              $userCheck = Get-LocalUser -Name $env:RDP_USERNAME -ErrorAction SilentlyContinue
              if (-not $userCheck) {
                  throw "User creation verification failed"
              }
          }
          catch {
              Write-Host "âŒ Error creating user: $_" -ForegroundColor Red
              exit 1
          }
          
          Write-Host "`n" -ForegroundColor White

      - name: ğŸ“¦ Install Tailscale VPN
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘          INSTALLING TAILSCALE VPN CLIENT                    â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-${{ env.TAILSCALE_VERSION }}-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          # Download with retry mechanism
          $retryCount = 0
          $maxRetries = 3
          $downloaded = $false
          
          while (-not $downloaded -and $retryCount -lt $maxRetries) {
              try {
                  Write-Host "ğŸ“¥ Downloading Tailscale (attempt $($retryCount + 1)/$maxRetries)..." -ForegroundColor Yellow
                  Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -ErrorAction Stop
                  $downloaded = $true
                  Write-Host "âœ… Download successful" -ForegroundColor Green
              }
              catch {
                  $retryCount++
                  Write-Host "âš ï¸  Download failed: $_" -ForegroundColor Yellow
                  if ($retryCount -lt $maxRetries) {
                      Write-Host "â³ Retrying in 5 seconds..." -ForegroundColor Yellow
                      Start-Sleep -Seconds 5
                  }
              }
          }
          
          if (-not $downloaded) {
              Write-Host "âŒ Failed to download Tailscale after $maxRetries attempts" -ForegroundColor Red
              exit 1
          }
          
          # Install silently
          Write-Host "âš™ï¸  Installing Tailscale..." -ForegroundColor Yellow
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          
          # Verify installation
          $tailscalePath = "${env:ProgramFiles}\Tailscale\tailscale.exe"
          $tailscaledPath = "${env:ProgramFiles}\Tailscale\tailscaled.exe"
          
          if (Test-Path $tailscalePath) {
              Write-Host "âœ… Tailscale installed successfully" -ForegroundColor Green
              Remove-Item $installerPath -Force -ErrorAction SilentlyContinue
          }
          else {
              Write-Host "âŒ Tailscale installation failed" -ForegroundColor Red
              exit 1
          }
          
          Write-Host "`n" -ForegroundColor White

      - name: ğŸ”Œ Establish Tailscale Connection
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘          CONNECTING TO TAILSCALE NETWORK                    â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          
          $tailscalePath = "${env:ProgramFiles}\Tailscale\tailscale.exe"
          $tailscaledPath = "${env:ProgramFiles}\Tailscale\tailscaled.exe"
          $hostname = "${{ github.event.inputs.hostname || 'windows-app-runner' }}-$env:GITHUB_RUN_ID-$env:GITHUB_RUN_NUMBER"
          
          # Check auth key
          if (-not $env:TAILSCALE_AUTH_KEY) {
              Write-Host "âŒ TAILSCALE_AUTH_KEY not found in secrets!" -ForegroundColor Red
              Write-Host "   Please add it to: Settings â†’ Secrets and variables â†’ Actions" -ForegroundColor Yellow
              exit 1
          }
          
          # Start service if not running
          $service = Get-Service -Name Tailscaled -ErrorAction SilentlyContinue
          if (-not $service -or $service.Status -ne 'Running') {
              Write-Host "âš™ï¸  Starting Tailscale service..." -ForegroundColor Yellow
              Start-Process -FilePath $tailscaledPath -ArgumentList "/install", "/service" -Wait
              Start-Sleep -Seconds 5
          }
          
          # Build connection arguments
          $connectArgs = @("up", 
              "--authkey=$env:TAILSCALE_AUTH_KEY", 
              "--hostname=$hostname",
              "--accept-dns=true",
              "--accept-routes=true"
          )
          
          # Add optional features
          if ("${{ github.event.inputs.enable_ssh }}" -eq "true") {
              $connectArgs += "--ssh"
              Write-Host "âœ… SSH server enabled" -ForegroundColor Green
          }
          
          if ("${{ github.event.inputs.enable_exit_node }}" -eq "true") {
              $connectArgs += "--advertise-exit-node"
              Write-Host "âœ… Exit node enabled" -ForegroundColor Green
          }
          
          if ("${{ github.event.inputs.advertise_routes }}" -ne "") {
              $connectArgs += "--advertise-routes=${{ github.event.inputs.advertise_routes }}"
              Write-Host "âœ… Advertise routes: ${{ github.event.inputs.advertise_routes }}" -ForegroundColor Green
          }
          
          # Connect to Tailscale
          Write-Host "ğŸ”— Connecting to Tailscale network..." -ForegroundColor Yellow
          & $tailscalePath $connectArgs
          
          # Wait for IP assignment with timeout
          $tsIP = $null
          $retries = 0
          $maxRetries = 30
          
          Write-Host "â³ Waiting for IP address assignment..." -ForegroundColor Yellow
          while (-not $tsIP -and $retries -lt $maxRetries) {
              $tsIP = & $tailscalePath ip -4 2>$null
              Start-Sleep -Seconds 2
              $retries++
              
              if ($retries % 5 -eq 0) {
                  Write-Host "   Still waiting... ($retries/$maxRetries)" -ForegroundColor Gray
              }
          }
          
          if (-not $tsIP) {
              Write-Host "âŒ Failed to get Tailscale IP address" -ForegroundColor Red
              Write-Host "ğŸ“Š Current status:" -ForegroundColor Yellow
              & $tailscalePath status
              exit 1
          }
          
          # Get additional info
          $status = & $tailscalePath status --json | ConvertFrom-Json
          $dnsName = $status.Self.DNSName
          
          # Save to environment
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          echo "TAILSCALE_HOSTNAME=$hostname" >> $env:GITHUB_ENV
          echo "TAILSCALE_DNS=$dnsName" >> $env:GITHUB_ENV
          
          Write-Host "âœ… Connected to Tailscale!" -ForegroundColor Green
          Write-Host "   IP Address: $tsIP" -ForegroundColor Cyan
          Write-Host "   Hostname: $hostname" -ForegroundColor Cyan
          Write-Host "   DNS Name: $dnsName" -ForegroundColor Cyan
          
          Write-Host "`n" -ForegroundColor White

      - name: âœ… Verify RDP Accessibility
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘          VERIFYING RDP ACCESSIBILITY                        â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          
          $rdpPort = "${{ github.event.inputs.rdp_port || '3389' }}"
          
          # Check RDP service
          $rdpService = Get-Service -Name TermService -ErrorAction SilentlyContinue
          if ($rdpService.Status -eq "Running") {
              Write-Host "âœ… Remote Desktop Service: Running" -ForegroundColor Green
          } else {
              Write-Host "âš ï¸  Remote Desktop Service: $($rdpService.Status)" -ForegroundColor Yellow
          }
          
          # Check port listening
          $netstat = netstat -an | Select-String ":$rdpPort"
          if ($netstat -match "LISTENING") {
              Write-Host "âœ… RDP Port $rdpPort: Listening" -ForegroundColor Green
          } else {
              Write-Host "âš ï¸  RDP Port $rdpPort: Not listening" -ForegroundColor Yellow
          }
          
          # Test connectivity via Tailscale
          try {
              $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port $rdpPort -WarningAction SilentlyContinue
              if ($testResult.TcpTestSucceeded) {
                  Write-Host "âœ… RDP accessible via Tailscale IP: $env:TAILSCALE_IP" -ForegroundColor Green
              } else {
                  Write-Host "âš ï¸  Cannot verify RDP via Tailscale (may still work)" -ForegroundColor Yellow
              }
          }
          catch {
              Write-Host "âš ï¸  Connectivity test failed: $_" -ForegroundColor Yellow
          }
          
          Write-Host "`n" -ForegroundColor White

      - name: ğŸ“„ Create Connection Files
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘          CREATING CONNECTION FILES                          â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          
          $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          
          # Create RDP file
          $rdpFile = @"
full address:s:$env:TAILSCALE_IP:${{ github.event.inputs.rdp_port || '3389' }}
username:s:$env:RDP_USERNAME
screen mode id:i:2
desktopwidth:i:1920
desktopheight:i:1080
session bpp:i:32
winposstr:s:0,1,0,0,800,600
compression:i:1
keyboardhook:i:2
audiocapturemode:i:0
videoplaybackmode:i:1
connection type:i:7
networkautodetect:i:1
bandwidthautodetect:i:1
displayconnectionbar:i:1
enableworkspacereconnect:i:0
disable wallpaper:i:0
allow font smoothing:i:0
allow desktop composition:i:0
disable full window drag:i:1
disable menu anims:i:1
disable themes:i:0
disable cursor setting:i:0
bitmapcachepersistenable:i:1
audiomode:i:0
redirectprinters:i:0
redirectsmartcards:i:0
redirectclipboard:i:1
redirectposdevices:i:0
drivestoredirect:s:
authentication level:i:0
prompt for credentials:i:1
negotiate security layer:i:1
remoteapplicationmode:i:0
"@
          
          Set-Content -Path "$env:RUNNER_TEMP\connection-$env:GITHUB_RUN_ID.rdp" -Value $rdpFile -Encoding ASCII
          Write-Host "âœ… RDP file created" -ForegroundColor Green
          
          # Create instructions file
          $instructions = @"
=============================================
TAILSCALE WINDOWS APP CONNECTOR
=============================================

ğŸ“‹ CONNECTION DETAILS
--------------------
Generated: $timestamp
Session ID: $env:GITHUB_RUN_ID

ğŸŒ NETWORK
---------
Tailscale IP: $env:TAILSCALE_IP
Hostname: $env:TAILSCALE_HOSTNAME
RDP Port: ${{ github.event.inputs.rdp_port || '3389' }}

ğŸ‘¤ CREDENTIALS
------------
Username: $env:RDP_USERNAME
Password: $env:RDP_PASSWORD

ğŸš€ HOW TO CONNECT
---------------
1. Install Tailscale on your local machine
2. Connect to same Tailscale network
3. Open Windows App (Remote Desktop)
4. Add PC with IP: $env:TAILSCALE_IP
5. Login with credentials above

â±ï¸ SESSION INFO
-------------
Started: $timestamp
Duration: ${{ github.event.inputs.session_duration == 0 && '3 days' || github.event.inputs.session_duration + ' minutes' }}
Auto-recovery: ${{ github.event.inputs.enable_auto_recovery }}

âš ï¸  IMPORTANT
-----------
- Save these credentials NOW!
- Password will NOT be shown again
- Session ends when workflow is cancelled

=============================================
"@
          
          Set-Content -Path "$env:RUNNER_TEMP\instructions-$env:GITHUB_RUN_ID.txt" -Value $instructions
          Write-Host "âœ… Instructions file created" -ForegroundColor Green
          
          Write-Host "`n" -ForegroundColor White

      - name: ğŸ“¤ Upload Connection Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-app-connection-${{ github.run_id }}-${{ github.run_number }}
          path: |
            ${{ runner.temp }}\*.rdp
            ${{ runner.temp }}\*.txt
          retention-days: 3
          if-no-files-found: warn

      - name: ğŸ¯ Display Connection Information
        run: |
          Clear-Host
          Write-Host "`n" -ForegroundColor White
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Magenta
          Write-Host "â•‘                                                                                            â•‘" -ForegroundColor Magenta
          Write-Host "â•‘                    ğŸš€ TAILSCALE WINDOWS APP CONNECTOR - ACTIVE ğŸš€                         â•‘" -ForegroundColor Magenta
          Write-Host "â•‘                                                                                            â•‘" -ForegroundColor Magenta
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Magenta
          Write-Host "â•‘                                                                                            â•‘" -ForegroundColor Magenta
          Write-Host "â•‘  ğŸ“ CONNECTION DETAILS                                                                     â•‘" -ForegroundColor Cyan
          Write-Host "â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘" -ForegroundColor Cyan
          Write-Host "â•‘                                                                                            â•‘" -ForegroundColor Magenta
          Write-Host "â•‘    ğŸŒ Tailscale IP:     $($env:TAILSCALE_IP)" -ForegroundColor White
          Write-Host "â•‘    ğŸ–¥ï¸  Hostname:         $($env:TAILSCALE_HOSTNAME)" -ForegroundColor White
          Write-Host "â•‘    ğŸ”Œ RDP Port:         ${{ github.event.inputs.rdp_port || '3389' }}" -ForegroundColor White
          Write-Host "â•‘                                                                                            â•‘" -ForegroundColor Magenta
          Write-Host "â•‘  ğŸ‘¤ CREDENTIALS (SAVE NOW!)                                                               â•‘" -ForegroundColor Yellow
          Write-Host "â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘" -ForegroundColor Yellow
          Write-Host "â•‘                                                                                            â•‘" -ForegroundColor Magenta
          Write-Host "â•‘    ğŸ‘¥ Username:         $($env:RDP_USERNAME)" -ForegroundColor Green
          Write-Host "â•‘    ğŸ”‘ Password:         $($env:RDP_PASSWORD)" -ForegroundColor Red
          Write-Host "â•‘                                                                                            â•‘" -ForegroundColor Magenta
          Write-Host "â•‘  ğŸ”§ WINDOWS APP CONNECTION                                                                â•‘" -ForegroundColor Cyan
          Write-Host "â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘" -ForegroundColor Cyan
          Write-Host "â•‘                                                                                            â•‘" -ForegroundColor Magenta
          Write-Host "â•‘    1.  Buka Windows App (Remote Desktop)                                                  â•‘" -ForegroundColor White
          Write-Host "â•‘    2.  Klik 'Add PC' atau '+'                                                            â•‘" -ForegroundColor White
          Write-Host "â•‘    3.  Masukkan IP Address: $($env:TAILSCALE_IP)" -ForegroundColor White
          Write-Host "â•‘    4.  Masukkan Username: $($env:RDP_USERNAME)" -ForegroundColor White
          Write-Host "â•‘    5.  Masukkan Password: [lihat di atas]                                                â•‘" -ForegroundColor White
          Write-Host "â•‘    6.  Klik Connect                                                                       â•‘" -ForegroundColor White
          Write-Host "â•‘                                                                                            â•‘" -ForegroundColor Magenta
          Write-Host "â•‘  âš¡ SESSION INFORMATION                                                                    â•‘" -ForegroundColor Cyan
          Write-Host "â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘" -ForegroundColor Cyan
          Write-Host "â•‘                                                                                            â•‘" -ForegroundColor Magenta
          Write-Host "â•‘    â±ï¸  Session ID:       $env:GITHUB_RUN_ID" -ForegroundColor White
          Write-Host "â•‘    â³ Duration:         $(${{ github.event.inputs.session_duration == 0 && '3 days' || github.event.inputs.session_duration + ' minutes' }})" -ForegroundColor White
          Write-Host "â•‘    ğŸ”„ Auto-recovery:    $(${{ github.event.inputs.enable_auto_recovery && 'âœ… Enabled' || 'âŒ Disabled' }})" -ForegroundColor White
          Write-Host "â•‘    ğŸ“Š Check interval:   ${{ github.event.inputs.recovery_interval || 60 }} seconds" -ForegroundColor White
          Write-Host "â•‘                                                                                            â•‘" -ForegroundColor Magenta
          Write-Host "â•‘  ğŸ“ ARTIFACTS                                                                             â•‘" -ForegroundColor Cyan
          Write-Host "â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘" -ForegroundColor Cyan
          Write-Host "â•‘                                                                                            â•‘" -ForegroundColor Magenta
          Write-Host "â•‘    ğŸ“„ RDP File:         Download dari Artifacts (connection-$env:GITHUB_RUN_ID.rdp)     â•‘" -ForegroundColor White
          Write-Host "â•‘    ğŸ“‹ Instructions:     Download dari Artifacts (instructions-$env:GITHUB_RUN_ID.txt)    â•‘" -ForegroundColor White
          Write-Host "â•‘                                                                                            â•‘" -ForegroundColor Magenta
          Write-Host "â•‘  âš ï¸  WARNING                                                                               â•‘" -ForegroundColor Red
          Write-Host "â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘" -ForegroundColor Red
          Write-Host "â•‘                                                                                            â•‘" -ForegroundColor Magenta
          Write-Host "â•‘    â€¢ Password hanya ditampilkan SEKALI ini!                                               â•‘" -ForegroundColor Yellow
          Write-Host "â•‘    â€¢ Simpan credentials ini SEKARANG juga!                                               â•‘" -ForegroundColor Yellow
          Write-Host "â•‘    â€¢ Session akan BERAKHIR jika workflow di-cancel                                       â•‘" -ForegroundColor Yellow
          Write-Host "â•‘    â€¢ Gunakan 'Cancel workflow' untuk menghentikan session                               â•‘" -ForegroundColor Yellow
          Write-Host "â•‘                                                                                            â•‘" -ForegroundColor Magenta
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Magenta
          Write-Host "`n" -ForegroundColor White

      - name: ğŸ”„ Persistent Connection with Auto-Recovery
        if: always()
        run: |
          Write-Host "`n" -ForegroundColor Cyan
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘                    ğŸ”„ MAINTAINING PERSISTENT CONNECTION ğŸ”„                                â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host "`n" -ForegroundColor Cyan
          
          $tailscalePath = "${env:ProgramFiles}\Tailscale\tailscale.exe"
          $recoveryCount = 0
          $maxRecoveryAttempts = 100
          $checkInterval = ${{ github.event.inputs.recovery_interval || 60 }}
          $autoRecovery = $${{ github.event.inputs.enable_auto_recovery || true }}
          $lastRecoveryTime = $null
          
          function Test-TailscaleHealth {
              param([string]$TailscalePath)
              
              try {
                  # Check 1: Process exists
                  $process = Get-Process -Name "tailscaled" -ErrorAction SilentlyContinue
                  if (-not $process) { return $false }
                  
                  # Check 2: IP assigned
                  $ip = & $TailscalePath ip -4 2>$null
                  if (-not $ip) { return $false }
                  
                  # Check 3: Online status
                  $status = & $TailscalePath status --json 2>$null | ConvertFrom-Json
                  if (-not $status.Self.Online) { return $false }
                  
                  # Check 4: DNS resolution
                  $dnsTest = Resolve-DnsName -Name "tailscale.com" -ErrorAction SilentlyContinue
                  if (-not $dnsTest) { return $false }
                  
                  return $true
              }
              catch {
                  return $false
              }
          }
          
          function Repair-Tailscale {
              param(
                  [string]$TailscalePath,
                  [string]$AuthKey,
                  [string]$Hostname,
                  [int]$Attempt
              )
              
              Write-Host "`nâš ï¸  [$(Get-Date -Format 'HH:mm:ss')] Tailscale down! Attempting recovery #$Attempt..." -ForegroundColor Yellow
              
              try {
                  # Strategy 1: Quick restart
                  Write-Host "  ğŸ“‹ Strategy 1: Quick service restart..." -ForegroundColor Gray
                  Restart-Service -Name Tailscaled -Force -ErrorAction SilentlyContinue
                  Start-Sleep -Seconds 10
                  
                  $ip = & $TailscalePath ip -4 2>$null
                  if ($ip) {
                      Write-Host "  âœ… Quick restart successful!" -ForegroundColor Green
                      return $ip
                  }
                  
                  # Strategy 2: Full reconnect
                  Write-Host "  ğŸ“‹ Strategy 2: Full reconnect..." -ForegroundColor Gray
                  & $TailscalePath down
                  Start-Sleep -Seconds 5
                  & $TailscalePath up --authkey=$AuthKey --hostname=$Hostname --reset
                  Start-Sleep -Seconds 15
                  
                  $ip = & $TailscalePath ip -4 2>$null
                  if ($ip) {
                      Write-Host "  âœ… Full reconnect successful!" -ForegroundColor Green
                      return $ip
                  }
                  
                  # Strategy 3: Service reinstall
                  Write-Host "  ğŸ“‹ Strategy 3: Service reinstall..." -ForegroundColor Gray
                  & "${env:ProgramFiles}\Tailscale\tailscaled.exe" /uninstall /service 2>$null
                  Start-Sleep -Seconds 3
                  & "${env:ProgramFiles}\Tailscale\tailscaled.exe" /install /service 2>$null
                  Start-Sleep -Seconds 5
                  Start-Service -Name Tailscaled -ErrorAction SilentlyContinue
                  Start-Sleep -Seconds 10
                  & $TailscalePath up --authkey=$AuthKey --hostname=$Hostname
                  Start-Sleep -Seconds 15
                  
                  $ip = & $TailscalePath ip -4 2>$null
                  if ($ip) {
                      Write-Host "  âœ… Service reinstall successful!" -ForegroundColor Green
                      return $ip
                  }
                  
                  Write-Host "  âŒ All recovery strategies failed" -ForegroundColor Red
                  return $null
              }
              catch {
                  Write-Host "  âŒ Recovery error: $_" -ForegroundColor Red
                  return $null
              }
          }
          
          # Main monitoring loop
          while ($true) {
              $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
              $healthStatus = Test-TailscaleHealth -TailscalePath $tailscalePath
              
              if ($healthStatus) {
                  # Reset recovery counter if healthy
                  if ($recoveryCount -gt 0) {
                      Write-Host "[$timestamp] âœ… Tailscale recovered - Reset counter" -ForegroundColor Green
                      $recoveryCount = 0
                  }
                  
                  # Normal heartbeat
                  $currentIP = & $tailscalePath ip -4
                  $status = & $tailscalePath status --json | ConvertFrom-Json
                  $peerCount = ($status.Peer | Measure-Object).Count
                  Write-Host "[$timestamp] âœ… Tailscale: Connected | IP: $currentIP | Peers: $peerCount" -ForegroundColor Green
              }
              else {
                  Write-Host "[$timestamp] âš ï¸  Tailscale: Disconnected/Unhealthy" -ForegroundColor Yellow
                  
                  if ($autoRecovery -and $recoveryCount -lt $maxRecoveryAttempts) {
                      $recoveryCount++
                      $newIP = Repair-Tailscale -TailscalePath $tailscalePath `
                                               -AuthKey ${{ secrets.TAILSCALE_AUTH_KEY }} `
                                               -Hostname "${{ github.event.inputs.hostname || 'windows-app-runner' }}-$env:GITHUB_RUN_ID" `
                                               -Attempt $recoveryCount
                      
                      if ($newIP) {
                          # Update environment
                          $env:TAILSCALE_IP = $newIP
                          
                          # Recreate RDP file with new IP
                          $rdpFile = @"
full address:s:$newIP:${{ github.event.inputs.rdp_port || '3389' }}
username:s:$env:RDP_USERNAME
"@
                          Set-Content -Path "$env:RUNNER_TEMP\connection-$env:GITHUB_RUN_ID.rdp" -Value $rdpFile -Encoding ASCII
                          
                          Write-Host "[$timestamp] âœ… Recovery complete! New IP: $newIP" -ForegroundColor Green
                      }
                  }
                  elseif ($recoveryCount -ge $maxRecoveryAttempts) {
                      Write-Host "[$timestamp] âŒ Max recovery attempts reached. Manual intervention required." -ForegroundColor Red
                  }
              }
              
              Start-Sleep -Seconds $checkInterval
          }

      - name: ğŸ§¹ Cleanup Resources
        if: always()
        run: |
          Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Yellow
          Write-Host "â•‘          CLEANING UP RESOURCES                               â•‘" -ForegroundColor Yellow
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Yellow
          
          # Disconnect Tailscale
          $tailscalePath = "${env:ProgramFiles}\Tailscale\tailscale.exe"
          if (Test-Path $tailscalePath) {
              Write-Host "ğŸ“¤ Disconnecting from Tailscale..." -ForegroundColor Gray
              & $tailscalePath logout
              & $tailscalePath down
              Write-Host "âœ… Tailscale disconnected" -ForegroundColor Green
          }
          
          # Remove RDP user
          if (Get-LocalUser -Name $env:RDP_USERNAME -ErrorAction SilentlyContinue) {
              Write-Host "ğŸ‘¤ Removing RDP user: $env:RDP_USERNAME..." -ForegroundColor Gray
              Remove-LocalUser -Name $env:RDP_USERNAME -Confirm:$false
              Write-Host "âœ… User removed" -ForegroundColor Green
          }
          
          # Clean temp files
          Get-ChildItem -Path "$env:RUNNER_TEMP\*.rdp", "$env:RUNNER_TEMP\*.txt" -ErrorAction SilentlyContinue | 
              Remove-Item -Force -ErrorAction SilentlyContinue
          
          Write-Host "âœ… Cleanup completed at $(Get-Date)" -ForegroundColor Green
