name: ğŸš€ SkyRDP - UNLIMITED (FINAL FIX - NO CLEAR HOST)
on:
  workflow_dispatch:

env:
  RDP_USER: "Skyro"
  TAILSCALE_APP_NAME: "SkyRDP-Session"

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      - name: âš¡ Start Session
        run: |
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host "     SKYRDP UNLIMITED EDITION - FINAL FIX    " -ForegroundColor Cyan
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host "Session ID: $env:GITHUB_RUN_ID" -ForegroundColor Yellow
          Write-Host "Started at: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray

      - name: ğŸ”§ Setup RDP
        run: |
          Write-Host "ğŸ“¡ Configuring RDP..." -ForegroundColor Cyan
          
          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          
          # Firewall
          netsh advfirewall firewall delete rule name="RDP-SkyRDP" 2>$null
          netsh advfirewall firewall add rule name="RDP-SkyRDP" dir=in action=allow protocol=TCP localport=3389
          
          Restart-Service -Name TermService -Force
          Write-Host "âœ… RDP Configured" -ForegroundColor Green

      - name: ğŸ‘¤ Create User
        run: |
          Write-Host "ğŸ‘¤ Creating user..." -ForegroundColor Cyan
          
          # Generate password
          $pass = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 12 | % {[char]$_})
          
          # Create user
          $secPass = ConvertTo-SecureString $pass -AsPlainText -Force
          New-LocalUser -Name "$env:RDP_USER" -Password $secPass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "$env:RDP_USER"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "$env:RDP_USER"
          
          # Save credentials
          Write-Host "USERNAME=$env:RDP_USER" >> $env:GITHUB_ENV
          Write-Host "PASSWORD=$pass" >> $env:GITHUB_ENV
          
          Write-Host "âœ… User created: $env:RDP_USER" -ForegroundColor Green
          Write-Host "Password: $pass" -ForegroundColor Yellow

      - name: ğŸ”— Install Tailscale
        run: |
          Write-Host "ğŸ“¦ Installing Tailscale..." -ForegroundColor Cyan
          
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $msi = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $url -OutFile $msi -UseBasicParsing
          Start-Process msiexec.exe -ArgumentList "/i", "`"$msi`"", "/quiet", "/norestart" -Wait
          Remove-Item $msi -Force
          
          Write-Host "âœ… Tailscale installed" -ForegroundColor Green

      - name: ğŸŒ Connect Tailscale
        run: |
          Write-Host "ğŸŒ Connecting to Tailscale..." -ForegroundColor Cyan
          
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="$env:TAILSCALE_APP_NAME-$env:GITHUB_RUN_ID"
          
          # Get IP
          Write-Host "â³ Waiting for IP assignment..." -ForegroundColor Yellow
          $ip = $null
          for ($i=1; $i -le 10; $i++) {
              $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
              if ($ip) { 
                  Write-Host "âœ… IP assigned after $i attempts" -ForegroundColor Green
                  break 
              }
              Write-Host "   Attempt $i/10..."
              Start-Sleep -Seconds 5
          }
          
          if (-not $ip) {
              Write-Error "âŒ Failed to get Tailscale IP"
              exit 1
          }
          
          Write-Host "IP=$ip" >> $env:GITHUB_ENV
          Write-Host "âœ… Tailscale IP: $ip" -ForegroundColor Green

      - name: ğŸ¯ Show Connection Info
        run: |
          # Test connection
          Write-Host "ğŸ›¡ï¸ Testing RDP connection..." -ForegroundColor Cyan
          $test = Test-NetConnection -ComputerName $env:IP -Port 3389 -WarningAction SilentlyContinue
          
          if ($test.TcpTestSucceeded) {
              Write-Host "âœ… RDP Port 3389 is OPEN" -ForegroundColor Green
          } else {
              Write-Host "âš ï¸ RDP Port test failed - but will continue" -ForegroundColor Yellow
          }
          
          # Show info WITHOUT Clear-Host
          Write-Host ""
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host "           ğŸ” RDP ACCESS INFORMATION            " -ForegroundColor Cyan
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "  ğŸŒ IP Address  : $env:IP" -ForegroundColor Green
          Write-Host "  ğŸ”Œ Port        : 3389" -ForegroundColor Green
          Write-Host "  ğŸ‘¤ Username    : $env:USERNAME" -ForegroundColor Yellow
          Write-Host "  ğŸ”‘ Password    : $env:PASSWORD" -ForegroundColor Red
          Write-Host ""
          Write-Host "  ğŸ“ Connect CMD : mstsc /v:$env`:3389" -ForegroundColor White
          Write-Host ""
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host "  â° Session started at: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host "  â³ Max duration: 6 hours (auto-stop by GitHub)" -ForegroundColor Yellow
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""

      - name: ğŸ”„ Keep Alive - UNLIMITED MODE
        run: |
          Write-Host ""
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
          Write-Host "     ğŸš€ UNLIMITED MODE - JALAN TERUS           " -ForegroundColor Green
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
          Write-Host ""
          Write-Host "ğŸ“ IP: $env:IP:3389"
          Write-Host "ğŸ‘¤ User: $env:USERNAME"
          Write-Host "ğŸ”‘ Pass: $env:PASSWORD"
          Write-Host ""
          Write-Host "ğŸ›‘ STOP: Klik 'Cancel workflow' di GitHub"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
          Write-Host ""
          
          $counter = 0
          while ($true) {
              $counter++
              $now = Get-Date -Format "HH:mm:ss"
              
              if ($counter % 2 -eq 0) {  # Every 2 minutes
                  Write-Host "[$now] â¤ï¸ RDP ACTIVE - IP: $env:IP:3389" -ForegroundColor Green
                  
                  # Check connection every 10 minutes
                  if ($counter % 10 -eq 0) {
                      $test = Test-NetConnection -ComputerName $env:IP -Port 3389 -WarningAction SilentlyContinue
                      if ($test.TcpTestSucceeded) {
                          Write-Host "   âœ… Connection OK" -ForegroundColor Gray
                      } else {
                          Write-Host "   âš ï¸ Connection check failed" -ForegroundColor Yellow
                      }
                  }
              }
              
              Start-Sleep -Seconds 60
          }
