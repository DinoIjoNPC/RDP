name: Tailscale Windows App Connector

on:
  workflow_dispatch:
    inputs:
      hostname:
        description: 'Device hostname prefix'
        required: false
        default: 'windows-app-runner'
        type: string
      rdp_port:
        description: 'Custom RDP port (optional)'
        required: false
        default: '3389'
        type: string
      enable_ssh:
        description: 'Enable SSH access'
        required: false
        default: true
        type: boolean
      enable_exit_node:
        description: 'Enable as exit node'
        required: false
        default: false
        type: boolean
      advertise_routes:
        description: 'Advertise network routes (e.g., 192.168.1.0/24)'
        required: false
        default: ''
        type: string

env:
  TAILSCALE_VERSION: "1.82.0"
  RDP_USERNAME: "Skyro"

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 4320  # 3 days maximum
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate Secure Credentials
        id: credentials
        run: |
          # Generate random username and password
          $randomSuffix = -join ((65..90) + (97..122) | Get-Random -Count 6 | % {[char]$_})
          $username = "Skyro_$randomSuffix"
          
          # Generate strong password
          Add-Type -AssemblyName System.Security
          $charSet = @{
              Upper   = [char[]](65..90)      # A-Z
              Lower   = [char[]](97..122)     # a-z
              Number  = [char[]](48..57)      # 0-9
              Special = [char[]](33..47) + [char[]](58..64) +
                        [char[]](91..96) + [char[]](123..126) # Special characters
          }
          
          $rawPassword = @()
          $rawPassword += $charSet.Upper | Get-Random -Count 5
          $rawPassword += $charSet.Lower | Get-Random -Count 5
          $rawPassword += $charSet.Number | Get-Random -Count 5
          $rawPassword += $charSet.Special | Get-Random -Count 3
          $password = -join ($rawPassword | Sort-Object { Get-Random })
          
          # Save to environment
          echo "RDP_USERNAME=$username" >> $env:GITHUB_ENV
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          
          # Create GitHub Actions output
          echo "username=$username" >> $env:GITHUB_OUTPUT
          echo "password=$password" >> $env:GITHUB_OUTPUT
          
          Write-Host "Generated credentials for: $username" -ForegroundColor Green

      - name: Configure Advanced RDP Settings
        run: |
          Write-Host "Configuring Remote Desktop..." -ForegroundColor Cyan
          
          # Enable Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                          -Name "fDenyTSConnections" -Value 0 -Force
          
          # Disable Network Level Authentication (for compatibility)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                          -Name "UserAuthentication" -Value 0 -Force
          
          # Set security layer
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                          -Name "SecurityLayer" -Value 0 -Force
          
          # Configure RDP port
          $rdpPort = "${{ github.event.inputs.rdp_port || '3389' }}"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                          -Name "PortNumber" -Value $rdpPort -Force
          
          # Remove any existing firewall rules
          netsh advfirewall firewall delete rule name="RDP-Tailscale" 2>$null
          netsh advfirewall firewall delete rule name="RDP-Tailscale-IPv6" 2>$null
          
          # Add firewall rules for both IPv4 and IPv6
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
            dir=in action=allow protocol=TCP localport=$rdpPort
          
          netsh advfirewall firewall add rule name="RDP-Tailscale-IPv6" `
            dir=in action=allow protocol=TCP localport=$rdpPort
          
          # Restart Remote Desktop service
          Restart-Service -Name TermService -Force
          
          # Verify configuration
          $rdpStatus = Get-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections"
          Write-Host "RDP Enabled: $($rdpStatus.fDenyTSConnections -eq 0)" -ForegroundColor Green
          Write-Host "RDP Port: $rdpPort" -ForegroundColor Green

      - name: Create RDP User with Secure Password
        run: |
          Write-Host "Creating RDP user..." -ForegroundColor Cyan
          
          $securePass = ConvertTo-SecureString $env:RDP_PASSWORD -AsPlainText -Force
          
          # Create local user
          New-LocalUser -Name $env:RDP_USERNAME `
                       -Password $securePass `
                       -FullName "Tailscale RDP User" `
                       -Description "Remote Desktop User for Tailscale" `
                       -AccountNeverExpires `
                       -PasswordNeverExpires
          
          # Add to required groups
          Add-LocalGroupMember -Group "Administrators" -Member $env:RDP_USERNAME
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:RDP_USERNAME
          Add-LocalGroupMember -Group "Users" -Member $env:RDP_USERNAME
          
          # Verify user creation
          if (-not (Get-LocalUser -Name $env:RDP_USERNAME)) {
              Write-Error "User creation failed"
              exit 1
          }
          
          Write-Host "User created successfully: $env:RDP_USERNAME" -ForegroundColor Green

      - name: Install Tailscale
        run: |
          Write-Host "Installing Tailscale..." -ForegroundColor Cyan
          
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-${{ env.TAILSCALE_VERSION }}-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          # Download with retry
          $retryCount = 0
          $downloaded = $false
          while (-not $downloaded -and $retryCount -lt 3) {
              try {
                  Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -ErrorAction Stop
                  $downloaded = $true
              }
              catch {
                  $retryCount++
                  Write-Host "Download failed, retrying... ($retryCount/3)" -ForegroundColor Yellow
                  Start-Sleep -Seconds 5
              }
          }
          
          if (-not $downloaded) {
              Write-Error "Failed to download Tailscale installer"
              exit 1
          }
          
          # Install silently
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          
          # Verify installation
          $tailscalePath = "${env:ProgramFiles}\Tailscale\tailscale.exe"
          if (-not (Test-Path $tailscalePath)) {
              Write-Error "Tailscale installation failed"
              exit 1
          }
          
          Write-Host "Tailscale installed successfully" -ForegroundColor Green

      - name: Establish Tailscale Connection
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host "Connecting to Tailscale network..." -ForegroundColor Cyan
          
          $tailscalePath = "${env:ProgramFiles}\Tailscale\tailscale.exe"
          $hostname = "${{ github.event.inputs.hostname || 'windows-app-runner' }}-$env:GITHUB_RUN_ID"
          
          # Build connection command
          $connectArgs = @("up", "--authkey=$env:TAILSCALE_AUTH_KEY", "--hostname=$hostname")
          
          # Add optional features
          if ("${{ github.event.inputs.enable_ssh }}" -eq "true") {
              $connectArgs += "--ssh"
              Write-Host "SSH enabled" -ForegroundColor Yellow
          }
          
          if ("${{ github.event.inputs.enable_exit_node }}" -eq "true") {
              $connectArgs += "--advertise-exit-node"
              Write-Host "Exit node enabled" -ForegroundColor Yellow
          }
          
          if ("${{ github.event.inputs.advertise_routes }}" -ne "") {
              $connectArgs += "--advertise-routes=${{ github.event.inputs.advertise_routes }}"
              Write-Host "Advertise routes: ${{ github.event.inputs.advertise_routes }}" -ForegroundColor Yellow
          }
          
          # Connect to Tailscale
          & $tailscalePath $connectArgs
          
          # Wait for IP assignment with timeout
          $tsIP = $null
          $retries = 0
          $maxRetries = 15
          
          while (-not $tsIP -and $retries -lt $maxRetries) {
              $tsIP = & $tailscalePath ip -4
              Start-Sleep -Seconds 4
              $retries++
              Write-Host "Waiting for IP assignment... ($retries/$maxRetries)" -ForegroundColor Yellow
          }
          
          if (-not $tsIP) {
              Write-Error "Tailscale IP not assigned after $maxRetries attempts"
              
              # Show status for debugging
              & $tailscalePath status
              exit 1
          }
          
          # Get Tailscale status
          $tsStatus = & $tailscalePath status --json | ConvertFrom-Json
          $deviceName = $tsStatus.Self.DNSName
          
          # Save to environment
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          echo "TAILSCALE_HOSTNAME=$hostname" >> $env:GITHUB_ENV
          echo "TAILSCALE_DNS=$deviceName" >> $env:GITHUB_ENV
          
          Write-Host "Connected to Tailscale!" -ForegroundColor Green
          Write-Host "IP Address: $tsIP" -ForegroundColor Cyan
          Write-Host "Hostname: $hostname" -ForegroundColor Cyan

      - name: Verify RDP Accessibility
        run: |
          Write-Host "Verifying RDP accessibility..." -ForegroundColor Cyan
          
          $rdpPort = "${{ github.event.inputs.rdp_port || '3389' }}"
          
          # Test local RDP service
          $rdpService = Get-Service -Name TermService
          if ($rdpService.Status -ne "Running") {
              Write-Error "Remote Desktop Service is not running"
              exit 1
          }
          Write-Host "RDP Service: Running" -ForegroundColor Green
          
          # Test port listening
          $netstat = netstat -an | Select-String ":$rdpPort"
          if ($netstat -match "LISTENING") {
              Write-Host "RDP Port $rdpPort: Listening" -ForegroundColor Green
          } else {
              Write-Warning "RDP Port $rdpPort: Not listening"
          }
          
          # Test connectivity via Tailscale
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port $rdpPort -WarningAction SilentlyContinue
          
          if ($testResult.TcpTestSucceeded) {
              Write-Host "TCP connectivity to RDP port: SUCCESSFUL" -ForegroundColor Green
          } else {
              Write-Warning "TCP connectivity to RDP port: FAILED"
              Write-Host "This may be due to network configuration, but RDP should still work" -ForegroundColor Yellow
          }

      - name: Setup Windows App Connection Script
        run: |
          Write-Host "Creating connection scripts..." -ForegroundColor Cyan
          
          # Create Windows App connection script
          $connectionScript = @"
@echo off
echo ========================================
echo    Tailscale Windows App Connector
echo ========================================
echo.
echo Device IP: $env:TAILSCALE_IP
echo Hostname: $env:TAILSCALE_HOSTNAME
echo Username: $env:RDP_USERNAME
echo.
echo To connect via Windows App:
echo 1. Open Windows App (formerly Remote Desktop)
echo 2. Click "Add PC"
echo 3. Enter IP address: $env:TAILSCALE_IP
echo 4. Enter username: $env:RDP_USERNAME
echo 5. Use password provided below
echo.
echo ========================================
echo Password: $env:RDP_PASSWORD
echo ========================================
echo.
pause
"@
          
          Set-Content -Path "$env:RUNNER_TEMP\windows_app_connection.txt" -Value $connectionScript
          
          # Create RDP file
          $rdpFile = @"
full address:s:$env:TAILSCALE_IP
username:s:$env:RDP_USERNAME
screen mode id:i:2
desktopwidth:i:1920
desktopheight:i:1080
session bpp:i:32
winposstr:s:0,1,0,0,800,600
compression:i:1
keyboardhook:i:2
audiocapturemode:i:0
videoplaybackmode:i:1
connection type:i:7
networkautodetect:i:1
bandwidthautodetect:i:1
displayconnectionbar:i:1
enableworkspacereconnect:i:0
disable wallpaper:i:0
allow font smoothing:i:0
allow desktop composition:i:0
disable full window drag:i:1
disable menu anims:i:1
disable themes:i:0
disable cursor setting:i:0
bitmapcachepersistenable:i:1
audiomode:i:0
redirectprinters:i:0
redirectsmartcards:i:0
redirectclipboard:i:1
redirectposdevices:i:0
drivestoredirect:s:
authentication level:i:0
prompt for credentials:i:1
negotiate security layer:i:1
remoteapplicationmode:i:0
alternate shell:s:
shell working directory:s:
gatewayhostname:s:
gatewayusagemethod:i:0
gatewaycredentialssource:i:4
gatewayprofileusagemethod:i:0
promptcredentialonce:i:0
use redirection server name:i:0
rdgiskdcproxy:i:0
kdcproxyname:s:
"@
          
          Set-Content -Path "$env:RUNNER_TEMP\connection.rdp" -Value $rdpFile
          
          Write-Host "Connection scripts created successfully" -ForegroundColor Green

      - name: Display Connection Information
        run: |
          Write-Host "`n" -ForegroundColor White
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘           TAILSCALE WINDOWS APP CONNECTOR ACTIVE              â•‘" -ForegroundColor Cyan
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Cyan
          Write-Host "â•‘                                                                â•‘" -ForegroundColor Cyan
          Write-Host "â•‘  ğŸ“ CONNECTION DETAILS                                        â•‘" -ForegroundColor Cyan
          Write-Host "â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘" -ForegroundColor Cyan
          Write-Host "â•‘                                                                â•‘" -ForegroundColor Cyan
          Write-Host "â•‘    Tailscale IP:     $($env:TAILSCALE_IP)" -ForegroundColor White
          Write-Host "â•‘    Hostname:         $($env:TAILSCALE_HOSTNAME)" -ForegroundColor White
          Write-Host "â•‘    RDP Port:         ${{ github.event.inputs.rdp_port || '3389' }}" -ForegroundColor White
          Write-Host "â•‘    Username:         $($env:RDP_USERNAME)" -ForegroundColor White
          Write-Host "â•‘    Password:         $($env:RDP_PASSWORD)" -ForegroundColor Yellow
          Write-Host "â•‘                                                                â•‘" -ForegroundColor Cyan
          Write-Host "â•‘  ğŸ”§ WINDOWS APP CONNECTION                                    â•‘" -ForegroundColor Cyan
          Write-Host "â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘" -ForegroundColor Cyan
          Write-Host "â•‘                                                                â•‘" -ForegroundColor Cyan
          Write-Host "â•‘    1. Buka Windows App (Remote Desktop)                       â•‘" -ForegroundColor White
          Write-Host "â•‘    2. Add PC dengan IP: $($env:TAILSCALE_IP)" -ForegroundColor White
          Write-Host "â•‘    3. Login dengan:                                          â•‘" -ForegroundColor White
          Write-Host "â•‘       Username: $($env:RDP_USERNAME)" -ForegroundColor White
          Write-Host "â•‘       Password: [lihat di atas]                              â•‘" -ForegroundColor White
          Write-Host "â•‘                                                                â•‘" -ForegroundColor Cyan
          Write-Host "â•‘  âš¡ SESSION WILL EXPIRE IN 3 DAYS                            â•‘" -ForegroundColor Red
          Write-Host "â•‘  ğŸ”’ CREDENTIALS ARE SECURELY GENERATED PER SESSION           â•‘" -ForegroundColor Green
          Write-Host "â•‘                                                                â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host "`n" -ForegroundColor White

      - name: Upload Connection Files
        uses: actions/upload-artifact@v4
        with:
          name: windows-app-connection-${{ env.GITHUB_RUN_ID }}
          path: |
            ${{ runner.temp }}\windows_app_connection.txt
            ${{ runner.temp }}\connection.rdp
          retention-days: 3

      - name: Maintain Persistent Connection
        run: |
          Write-Host "`n=== MAINTAINING PERSISTENT CONNECTION ===" -ForegroundColor Cyan
          Write-Host "Workflow akan tetap aktif selama 3 hari" -ForegroundColor Yellow
          Write-Host "Gunakan 'Cancel workflow' untuk menghentikan" -ForegroundColor Yellow
          Write-Host "==========================================`n" -ForegroundColor Cyan
          
          $counter = 0
          $tailscalePath = "${env:ProgramFiles}\Tailscale\tailscale.exe"
          
          while ($true) {
              $counter++
              $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
              
              # Check Tailscale status periodically
              if ($counter % 12 -eq 0) {  # Every hour (12 * 5 minutes)
                  $status = & $tailscalePath status --json | ConvertFrom-Json
                  $peerCount = ($status.Peer | Measure-Object).Count
                  
                  Write-Host "[$timestamp] Tailscale Status: Connected | Peers: $peerCount | IP: $env:TAILSCALE_IP" -ForegroundColor Green
              } else {
                  Write-Host "[$timestamp] RDP Active - Use 'Cancel workflow' to terminate" -ForegroundColor Gray
              }
              
              Start-Sleep -Seconds 300  # 5 minutes
          }

      - name: Cleanup
        if: always()
        run: |
          Write-Host "Cleaning up..." -ForegroundColor Yellow
          
          # Disconnect from Tailscale
          $tailscalePath = "${env:ProgramFiles}\Tailscale\tailscale.exe"
          if (Test-Path $tailscalePath) {
              & $tailscalePath logout
              & $tailscalePath down
          }
          
          # Remove RDP user
          if (Get-LocalUser -Name $env:RDP_USERNAME -ErrorAction SilentlyContinue) {
              Remove-LocalUser -Name $env:RDP_USERNAME -Confirm:$false
              Write-Host "RDP user removed" -ForegroundColor Green
          }
          
          Write-Host "Cleanup completed" -ForegroundColor Green
