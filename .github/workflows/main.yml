name: üöÄ SkyRDP Premium - UNLIMITED EDITION
on:
  workflow_dispatch:
    inputs:
      mode:
        description: '‚è±Ô∏è Mode Session'
        required: true
        default: 'unlimited'
        type: choice
        options:
          - 'unlimited'
          - 'timed'

# Environment variables
env:
  RDP_USER: "SkyroAdmin"
  TAILSCALE_APP_NAME: "SkyRDP-Session"
  MAX_RETRIES: 3
  RETRY_DELAY: 10

jobs:
  secure-rdp:
    runs-on: windows-latest
    # Maximum GitHub timeout is 6 hours (360 minutes) untuk free account
    # Tapi kita akan pakai while loop untuk keep alive
    timeout-minutes: 360
    
    steps:
      - name: ‚ö° Initialize Session
        run: |
          Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
          Write-Host "‚ïë        SKYRDP PREMIUM - UNLIMITED EDITION üöÄ              ‚ïë" -ForegroundColor Cyan
          Write-Host "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" -ForegroundColor Cyan
          Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
          Write-Host "  Session akan jalan TERUS sampai di-stop manual!" -ForegroundColor Yellow
          Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
          Write-Host "  Mode: ${{ github.event.inputs.mode }}" -ForegroundColor Green
          Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Session ID: $env:GITHUB_RUN_ID" -ForegroundColor White
          Write-Host "Started at: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor White

      - name: üîß Configure Enhanced RDP Settings
        run: |
          try {
              Write-Host "üì° Configuring RDP settings..." -ForegroundColor Cyan
              
              # Enable Remote Desktop
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "UserAuthentication" -Value 0 -Force
              
              # Disable all timeouts (UNLIMITED)
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "MaxConnectionTime" -Value 0 -Force
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "MaxDisconnectionTime" -Value 0 -Force
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "MaxIdleTime" -Value 0 -Force
              
              # Firewall rule
              netsh advfirewall firewall delete rule name="RDP-SkyRDP" 2>$null
              netsh advfirewall firewall add rule name="RDP-SkyRDP" `
                dir=in action=allow protocol=TCP localport=3389
              
              # Restart service
              Restart-Service -Name TermService -Force
              
              Write-Host "‚úÖ RDP configured successfully (UNLIMITED MODE)" -ForegroundColor Green
              
          } catch {
              Write-Error "RDP configuration error: $_"
              exit 1
          }

      - name: üë§ Create Secure Admin User
        run: |
          try {
              Write-Host "üë§ Creating secure admin user..." -ForegroundColor Cyan
              
              # Generate strong password
              Add-Type -AssemblyName System.Security
              
              function Generate-SecurePassword {
                  $length = 20  # Lebih panjang untuk unlimited mode
                  $charSet = 'abcdefghijkmnpqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ23456789!@#$%^&*'.ToCharArray()
                  $rng = [System.Security.Cryptography.RNGCryptoServiceProvider]::new()
                  $bytes = [byte[]]::new($length)
                  $rng.GetBytes($bytes)
                  
                  $password = -join ($bytes | ForEach-Object {
                      $charSet[$_ % $charSet.Length]
                  })
                  
                  return $password
              }
              
              $password = Generate-SecurePassword
              $securePass = ConvertTo-SecureString $password -AsPlainText -Force
              
              # Remove existing user if present
              if (Get-LocalUser -Name $env:RDP_USER -ErrorAction SilentlyContinue) {
                  Remove-LocalUser -Name $env:RDP_USER -Confirm:$false
              }
              
              # Create new user
              New-LocalUser -Name $env:RDP_USER -Password $securePass -AccountNeverExpires -PasswordNeverExpires
              Add-LocalGroupMember -Group "Administrators" -Member $env:RDP_USER
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:RDP_USER
              
              # Store credentials
              $credsJson = @{
                  username = $env:RDP_USER
                  password = $password
                  timestamp = (Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
                  session_id = $env:GITHUB_RUN_ID
              } | ConvertTo-Json
              
              echo "RDP_CREDS=$credsJson" >> $env:GITHUB_ENV
              
              Write-Host "‚úÖ Admin user created successfully" -ForegroundColor Green
              
          } catch {
              Write-Error "Failed to create user: $_"
              exit 1
          }

      - name: üîó Install Tailscale
        run: |
          try {
              Write-Host "üì¶ Installing Tailscale..." -ForegroundColor Cyan
              
              $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
              $installerPath = "$env:TEMP\tailscale.msi"
              
              Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -UseBasicParsing
              Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
              Remove-Item $installerPath -Force
              
              Start-Sleep -Seconds 10
              Write-Host "‚úÖ Tailscale installed" -ForegroundColor Green
              
          } catch {
              Write-Error "Tailscale installation failed: $_"
              exit 1
          }

      - name: üåê Connect to Tailscale
        run: |
          try {
              Write-Host "üåê Connecting to Tailscale network..." -ForegroundColor Cyan
              
              $hostname = "$env:TAILSCALE_APP_NAME-$env:GITHUB_RUN_ID"
              
              & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
                --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
                --hostname=$hostname
              
              # Get IP
              $tsIP = $null
              $ipRetries = 0
              while (-not $tsIP -and $ipRetries -lt 15) {
                  $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
                  Start-Sleep -Seconds 5
                  $ipRetries++
              }
              
              if (-not $tsIP) {
                  throw "Tailscale IP not assigned"
              }
              
              echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
              Write-Host "‚úÖ Connected to Tailscale at IP: $tsIP" -ForegroundColor Green
              
          } catch {
              Write-Error "Tailscale connection failed: $_"
              exit 1
          }

      - name: üõ°Ô∏è Verify Connection
        run: |
          try {
              Write-Host "üõ°Ô∏è Verifying RDP accessibility..." -ForegroundColor Cyan
              
              $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue
              if (-not $testResult.TcpTestSucceeded) {
                  throw "Cannot establish RDP connection"
              }
              
              # Parse credentials
              $creds = $env:RDP_CREDS | ConvertFrom-Json
              
              # Clear and show banner
              Clear-Host
              Write-Host ""
              Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
              Write-Host "‚ïë                    üîê UNLIMITED RDP ACCESS                       ‚ïë" -ForegroundColor Cyan
              Write-Host "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" -ForegroundColor Cyan
              Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
              Write-Host "  üÜî Session ID    : $env:GITHUB_RUN_ID" -ForegroundColor White
              Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
              Write-Host "  üåê RDP Address   : $env:TAILSCALE_IP:3389" -ForegroundColor Green
              Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
              Write-Host "  üë§ Username      : $($creds.username)" -ForegroundColor Yellow
              Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
              Write-Host "  üîë Password      : $($creds.password)" -ForegroundColor Red
              Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
              Write-Host "  ‚è∞ Started       : $($creds.timestamp)" -ForegroundColor Gray
              Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
              Write-Host "  ‚ôæÔ∏è  Mode          : UNLIMITED (jalan terus)" -ForegroundColor Magenta
              Write-Host "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" -ForegroundColor Cyan
              Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
              Write-Host "  üìù QUICK CONNECT: mstsc /v:$env:TAILSCALE_IP:3389" -ForegroundColor White
              Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
              Write-Host "  üõë STOP SESSION : Cancel job di GitHub Actions" -ForegroundColor Red
              Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan
              Write-Host ""
              
              # Save credentials to file (optional)
              $creds | ConvertTo-Json | Out-File -FilePath "$env:USERPROFILE\Desktop\RDP-CREDS.txt"
              Write-Host "‚úÖ Credentials juga disimpan di Desktop/RDP-CREDS.txt" -ForegroundColor Gray
              
          } catch {
              Write-Error "Connection verification failed: $_"
              exit 1
          }

      - name: üîÑ UNLIMITED Mode - Keep Alive Forever
        run: |
          Write-Host ""
          Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Green
          Write-Host "‚ïë        üöÄ UNLIMITED MODE AKTIF - JALAN TERUS üöÄ           ‚ïë" -ForegroundColor Green
          Write-Host "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" -ForegroundColor Green
          Write-Host "‚ïë" -ForegroundColor Green -NoNewline
          Write-Host "  Session akan jalan SAMPAI KAMU STOP MANUAL" -ForegroundColor White
          Write-Host "‚ïë" -ForegroundColor Green -NoNewline
          Write-Host "  Cara stop: Klik tombol 'Cancel workflow' di GitHub" -ForegroundColor Yellow
          Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Green
          Write-Host ""
          
          $heartbeatCount = 0
          $reconnectCount = 0
          
          while ($true) {
              try {
                  $heartbeatCount++
                  
                  # Check connection every 30 seconds
                  if ($heartbeatCount % 6 -eq 0) {  # Every 3 minutes
                      $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue
                      
                      if (-not $testResult.TcpTestSucceeded) {
                          $reconnectCount++
                          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ‚ö†Ô∏è Koneksi terputus! Mencoba reconnect... ($reconnectCount)" -ForegroundColor Yellow
                          
                          # Try to reconnect Tailscale
                          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="$env:TAILSCALE_APP_NAME-$env:GITHUB_RUN_ID-reconnect" 2>$null
                          
                          # Restart RDP service
                          Restart-Service -Name TermService -Force 2>$null
                          
                          Start-Sleep -Seconds 10
                      }
                  }
                  
                  # Normal heartbeat - show every 60 seconds
                  if ($heartbeatCount % 2 -eq 0) {  # Every minute
                      $uptime = (Get-Date) - (Get-Date -Format 'yyyy-MM-dd HH:mm:ss' $env:GITHUB_WORKFLOW_REF)
                      $uptimeHours = [math]::Floor($uptime.TotalHours)
                      $uptimeMinutes = $uptime.Minutes
                      
                      Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ‚ù§Ô∏è RDP Active - Uptime: ${uptimeHours}h ${uptimeMinutes}m | Reconnects: $reconnectCount | IP: $env:TAILSCALE_IP" -ForegroundColor Green
                  }
                  
                  Start-Sleep -Seconds 30
                  
              } catch {
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ‚ö†Ô∏è Error in monitor: $_" -ForegroundColor Red
                  Start-Sleep -Seconds 60
              }
          }
