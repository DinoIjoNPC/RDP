name: ğŸš€ SkyRDP Premium - Secure & Reliable
on:
  workflow_dispatch:
    inputs:
      keep_alive:
        description: 'â±ï¸ Durasi Keep Alive (jam)'
        required: true
        default: '6'
        type: choice
        options:
          - '1'
          - '2'
          - '4'
          - '6'
          - '12'
          - '24'

# Environment variables for better management
env:
  RDP_USER: "SkyroAdmin"
  TAILSCALE_APP_NAME: "SkyRDP-Session"
  MAX_RETRIES: 3
  RETRY_DELAY: 10

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: ${{ inputs.keep_alive != '' && format('{0}', inputs.keep_alive) && github.event.inputs.keep_alive || '360' }}0
    
    steps:
      - name: âš¡ Initialize Session
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘     SKYRDP PREMIUM SESSION STARTED    â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host "Session ID: $env:GITHUB_RUN_ID" -ForegroundColor Yellow
          Write-Host "Started at: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Yellow

      - name: ğŸ”§ Configure Enhanced RDP Settings
        run: |
          try {
              # Enable Remote Desktop with optimal settings
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "UserAuthentication" -Value 0 -Force
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "SecurityLayer" -Value 0 -Force
              
              # Optimize RDP performance
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "MaxConnectionTime" -Value 0 -Force
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "MaxDisconnectionTime" -Value 0 -Force
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "MaxIdleTime" -Value 0 -Force
              
              # Configure firewall with retry mechanism
              $retryCount = 0
              $firewallSuccess = $false
              while (-not $firewallSuccess -and $retryCount -lt $env:MAX_RETRIES) {
                  try {
                      netsh advfirewall firewall delete rule name="RDP-SkyRDP"
                      netsh advfirewall firewall add rule name="RDP-SkyRDP" `
                        dir=in action=allow protocol=TCP localport=3389
                      $firewallSuccess = $true
                  } catch {
                      $retryCount++
                      Write-Warning "Firewall config failed, retrying ($retryCount/$env:MAX_RETRIES)..."
                      Start-Sleep -Seconds $env:RETRY_DELAY
                  }
              }
              
              # Restart service with verification
              Restart-Service -Name TermService -Force
              Start-Sleep -Seconds 5
              
              # Verify RDP is enabled
              $rdpStatus = Get-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections"
              if ($rdpStatus.fDenyTSConnections -eq 0) {
                  Write-Host "âœ… RDP configured successfully" -ForegroundColor Green
              } else {
                  throw "RDP configuration failed"
              }
          } catch {
              Write-Error "RDP configuration error: $_"
              exit 1
          }

      - name: ğŸ‘¤ Create Secure Admin User
        run: |
          try {
              # Generate cryptographically secure password
              Add-Type -AssemblyName System.Security
              
              function Generate-SecurePassword {
                  $length = 16
                  $charSet = 'abcdefghijkmnpqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ23456789!@#$%^&*'.ToCharArray()
                  $rng = [System.Security.Cryptography.RNGCryptoServiceProvider]::new()
                  $bytes = [byte[]]::new($length)
                  $rng.GetBytes($bytes)
                  
                  $password = -join ($bytes | ForEach-Object {
                      $charSet[$_ % $charSet.Length]
                  })
                  
                  # Ensure at least one of each type
                  if ($password -notmatch '[A-Z]') { $password = 'A' + $password.Substring(1) }
                  if ($password -notmatch '[a-z]') { $password = 'a' + $password.Substring(1) }
                  if ($password -notmatch '[0-9]') { $password = '9' + $password.Substring(1) }
                  if ($password -notmatch '[!@#$%^&*]') { $password = '!' + $password.Substring(1) }
                  
                  return $password
              }
              
              $password = Generate-SecurePassword
              $securePass = ConvertTo-SecureString $password -AsPlainText -Force
              
              # Remove existing user if present
              if (Get-LocalUser -Name $env:RDP_USER -ErrorAction SilentlyContinue) {
                  Remove-LocalUser -Name $env:RDP_USER -Confirm:$false
                  Start-Sleep -Seconds 2
              }
              
              # Create new user
              New-LocalUser -Name $env:RDP_USER -Password $securePass -AccountNeverExpires -PasswordNeverExpires
              Add-LocalGroupMember -Group "Administrators" -Member $env:RDP_USER
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:RDP_USER
              
              # Store credentials securely in GitHub environment
              $credsJson = @{
                  username = $env:RDP_USER
                  password = $password
                  timestamp = (Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
                  session_id = $env:GITHUB_RUN_ID
              } | ConvertTo-Json
              
              echo "RDP_CREDS=$credsJson" >> $env:GITHUB_ENV
              
              Write-Host "âœ… Admin user created successfully" -ForegroundColor Green
              
          } catch {
              Write-Error "Failed to create user: $_"
              exit 1
          }

      - name: ğŸ”— Install & Configure Tailscale
        run: |
          try {
              # Download with retry mechanism
              $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
              $installerPath = "$env:TEMP\tailscale.msi"
              
              $retryCount = 0
              $downloadSuccess = $false
              while (-not $downloadSuccess -and $retryCount -lt $env:MAX_RETRIES) {
                  try {
                      Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -UseBasicParsing
                      $downloadSuccess = $true
                  } catch {
                      $retryCount++
                      Write-Warning "Download failed, retrying ($retryCount/$env:MAX_RETRIES)..."
                      Start-Sleep -Seconds $env:RETRY_DELAY
                  }
              }
              
              # Install silently
              Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
              Remove-Item $installerPath -Force
              
              # Wait for installation
              Start-Sleep -Seconds 10
              
              Write-Host "âœ… Tailscale installed" -ForegroundColor Green
              
          } catch {
              Write-Error "Tailscale installation failed: $_"
              exit 1
          }

      - name: ğŸŒ Establish Tailscale Connection
        run: |
          try {
              # Generate unique hostname
              $hostname = "$env:TAILSCALE_APP_NAME-$env:GITHUB_RUN_ID"
              
              # Connect to Tailscale with retry
              $retryCount = 0
              $connected = $false
              while (-not $connected -and $retryCount -lt $env:MAX_RETRIES) {
                  try {
                      & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
                        --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
                        --hostname=$hostname `
                        --advertise-tags=tag:rdp-access
                      
                      $connected = $true
                  } catch {
                      $retryCount++
                      Write-Warning "Connection failed, retrying ($retryCount/$env:MAX_RETRIES)..."
                      Start-Sleep -Seconds $env:RETRY_DELAY
                  }
              }
              
              # Wait for IP assignment
              $tsIP = $null
              $ipRetries = 0
              while (-not $tsIP -and $ipRetries -lt 15) {
                  $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
                  Start-Sleep -Seconds 5
                  $ipRetries++
                  Write-Host "Waiting for IP assignment... ($ipRetries/15)" -ForegroundColor Yellow
              }
              
              if (-not $tsIP) {
                  throw "Tailscale IP not assigned"
              }
              
              # Store IP in environment
              echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
              
              Write-Host "âœ… Connected to Tailscale at IP: $tsIP" -ForegroundColor Green
              
          } catch {
              Write-Error "Tailscale connection failed: $_"
              exit 1
          }

      - name: ğŸ›¡ï¸ Verify & Monitor Connection
        run: |
          try {
              # Test connection with retry
              $retryCount = 0
              $connected = $false
              while (-not $connected -and $retryCount -lt $env:MAX_RETRIES) {
                  $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue
                  if ($testResult.TcpTestSucceeded) {
                      $connected = $true
                  } else {
                      $retryCount++
                      Write-Warning "Connection test failed, retrying ($retryCount/$env:MAX_RETRIES)..."
                      Start-Sleep -Seconds $env:RETRY_DELAY
                  }
              }
              
              if (-not $connected) {
                  throw "Cannot establish RDP connection"
              }
              
              # Parse credentials for display
              $creds = $env:RDP_CREDS | ConvertFrom-Json
              
              # Display connection info with style
              Write-Host ""
              Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
              Write-Host "â•‘                    ğŸ” RDP ACCESS DETAILS                   â•‘" -ForegroundColor Cyan
              Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Cyan
              Write-Host "â•‘" -ForegroundColor Cyan -NoNewline
              Write-Host "  Session ID    : $env:GITHUB_RUN_ID" -ForegroundColor White
              Write-Host "â•‘" -ForegroundColor Cyan -NoNewline
              Write-Host "  RDP Address   : $env:TAILSCALE_IP:3389" -ForegroundColor Green
              Write-Host "â•‘" -ForegroundColor Cyan -NoNewline
              Write-Host "  Username      : $($creds.username)" -ForegroundColor Yellow
              Write-Host "â•‘" -ForegroundColor Cyan -NoNewline
              Write-Host "  Password      : $($creds.password)" -ForegroundColor Red
              Write-Host "â•‘" -ForegroundColor Cyan -NoNewline
              Write-Host "  Started at    : $($creds.timestamp)" -ForegroundColor Gray
              Write-Host "â•‘" -ForegroundColor Cyan -NoNewline
              Write-Host "  Time limit    : ${{ inputs.keep_alive }} hours" -ForegroundColor Magenta
              Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Cyan
              Write-Host "â•‘" -ForegroundColor Cyan -NoNewline
              Write-Host "  ğŸ“± Quick Connect: mstsc /v:$env:TAILSCALE_IP:3389" -ForegroundColor White
              Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
              Write-Host ""
              
          } catch {
              Write-Error "Connection verification failed: $_"
              exit 1
          }

      - name: ğŸ”„ Heartbeat Monitor
        run: |
          $durationHours = [int]"${{ inputs.keep_alive }}"
          $endTime = (Get-Date).AddHours($durationHours)
          $checkInterval = 60  # seconds
          $lastHeartbeat = Get-Date
          
          Write-Host "â¤ï¸ Heartbeat monitor started - Will run for $durationHours hours" -ForegroundColor Green
          
          while ((Get-Date) -lt $endTime) {
              try {
                  # Check Tailscale connection
                  $tsStatus = & "$env:ProgramFiles\Tailscale\tailscale.exe" status
                  
                  # Check RDP service
                  $rdpService = Get-Service -Name TermService -ErrorAction SilentlyContinue
                  
                  if ($tsStatus -and $rdpService.Status -eq 'Running') {
                      if (((Get-Date) - $lastHeartbeat).TotalSeconds -ge $checkInterval) {
                          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] â¤ï¸ Session healthy - Time remaining: $([math]::Round(($endTime - (Get-Date)).TotalHours, 2))h" -ForegroundColor Green
                          $lastHeartbeat = Get-Date
                      }
                  } else {
                      Write-Warning "Service check warning - attempting recovery"
                      
                      # Auto-recovery attempts
                      if (-not $tsStatus) {
                          Write-Host "ğŸ”„ Reconnecting Tailscale..."
                          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=$env:TAILSCALE_APP_NAME-$env:GITHUB_RUN_ID-reconnect
                      }
                      
                      if ($rdpService.Status -ne 'Running') {
                          Write-Host "ğŸ”„ Restarting RDP service..."
                          Restart-Service -Name TermService -Force
                      }
                  }
                  
                  Start-Sleep -Seconds 10
                  
              } catch {
                  Write-Warning "Heartbeat error: $_"
                  Start-Sleep -Seconds 30
              }
          }
          
          Write-Host ""
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Yellow
          Write-Host "â•‘     SESSION COMPLETED SUCCESSFULLY    â•‘" -ForegroundColor Yellow
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Yellow
