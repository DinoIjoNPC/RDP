name: üöÄ SkyRDP - UNLIMITED (FINAL FIX)
on:
  workflow_dispatch:

env:
  RDP_USER: "Skyro"
  TAILSCALE_APP_NAME: "SkyRDP-Session"

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      - name: ‚ö° Start Session
        run: |
          Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
          Write-Host "‚ïë    SKYRDP UNLIMITED EDITION   ‚ïë" -ForegroundColor Cyan
          Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan
          Write-Host "Session: $env:GITHUB_RUN_ID" -ForegroundColor Yellow

      - name: üîß Setup RDP
        run: |
          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          
          # Firewall
          netsh advfirewall firewall delete rule name="RDP-SkyRDP" 2>$null
          netsh advfirewall firewall add rule name="RDP-SkyRDP" dir=in action=allow protocol=TCP localport=3389
          
          Restart-Service -Name TermService -Force
          Write-Host "‚úÖ RDP OK" -ForegroundColor Green

      - name: üë§ Create User
        run: |
          # Generate password simple
          $pass = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 12 | % {[char]$_})
          
          # Create user
          $secPass = ConvertTo-SecureString $pass -AsPlainText -Force
          New-LocalUser -Name "$env:RDP_USER" -Password $secPass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "$env:RDP_USER"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "$env:RDP_USER"
          
          # SIMPLE - langsung set variable tanpa JSON
          Write-Host "USERNAME=$env:RDP_USER" >> $env:GITHUB_ENV
          Write-Host "PASSWORD=$pass" >> $env:GITHUB_ENV
          
          Write-Host "‚úÖ User: $env:RDP_USER" -ForegroundColor Green
          Write-Host "‚úÖ Pass: $pass" -ForegroundColor Green

      - name: üîó Install Tailscale
        run: |
          Write-Host "üì¶ Installing Tailscale..."
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $msi = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $url -OutFile $msi -UseBasicParsing
          Start-Process msiexec.exe -ArgumentList "/i", "`"$msi`"", "/quiet", "/norestart" -Wait
          Remove-Item $msi -Force
          Write-Host "‚úÖ Tailscale OK" -ForegroundColor Green

      - name: üåê Connect Tailscale
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="$env:TAILSCALE_APP_NAME-$env:GITHUB_RUN_ID"
          
          # Get IP
          $ip = $null
          for ($i=0; $i -lt 10; $i++) {
              $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              if ($ip) { break }
              Start-Sleep -Seconds 5
          }
          
          Write-Host "IP=$ip" >> $env:GITHUB_ENV
          Write-Host "‚úÖ IP: $ip" -ForegroundColor Green

      - name: üéØ Show Info
        run: |
          Clear-Host
          Write-Host ""
          Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
          Write-Host "‚ïë         üîê RDP READY TO USE         ‚ïë" -ForegroundColor Cyan
          Write-Host "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" -ForegroundColor Cyan
          Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
          Write-Host "  IP Address  : $env:IP:3389" -ForegroundColor Green
          Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
          Write-Host "  Username    : $env:USERNAME" -ForegroundColor Yellow
          Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
          Write-Host "  Password    : $env:PASSWORD" -ForegroundColor Red
          Write-Host "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" -ForegroundColor Cyan
          Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
          Write-Host "  Connect: mstsc /v:$env:IP:3389" -ForegroundColor White
          Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan
          Write-Host ""

      - name: üîÑ Keep Alive
        run: |
          Write-Host "‚ù§Ô∏è UNLIMITED MODE - Jalan terus sampai di-cancel" -ForegroundColor Green
          while ($true) {
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] RDP: $env:IP:3389 | User: $env:USERNAME" -ForegroundColor Green
              Start-Sleep -Seconds 60
          }              # SIMPLE FORMAT - No JSON, langsung string biasa
              echo "RDP_USERNAME=$env:RDP_USER" >> $env:GITHUB_ENV
              echo "RDP_PASSWORD=$PASSWORD" >> $env:GITHUB_ENV
              echo "RDP_TIMESTAMP=$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" >> $env:GITHUB_ENV
              
              Write-Host "‚úÖ Admin user created successfully" -ForegroundColor Green
              Write-Host "Username: $env:RDP_USER" -ForegroundColor Yellow
              Write-Host "Password: $PASSWORD" -ForegroundColor Green
              
          } catch {
              Write-Error "Failed to create user: $_"
              exit 1
          }

      - name: üîó Install Tailscale
        run: |
          try {
              Write-Host "üì¶ Installing Tailscale..." -ForegroundColor Cyan
              
              $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
              $installerPath = "$env:TEMP\tailscale.msi"
              
              Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -UseBasicParsing
              Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
              Remove-Item $installerPath -Force
              
              Start-Sleep -Seconds 10
              Write-Host "‚úÖ Tailscale installed" -ForegroundColor Green
              
          } catch {
              Write-Error "Tailscale installation failed: $_"
              exit 1
          }

      - name: üåê Connect to Tailscale
        run: |
          try {
              Write-Host "üåê Connecting to Tailscale network..." -ForegroundColor Cyan
              
              $hostname = "$env:TAILSCALE_APP_NAME-$env:GITHUB_RUN_ID"
              
              & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
                --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
                --hostname=$hostname
              
              # Get IP
              $tsIP = $null
              $ipRetries = 0
              while (-not $tsIP -and $ipRetries -lt 15) {
                  $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
                  Start-Sleep -Seconds 5
                  $ipRetries++
              }
              
              if (-not $tsIP) {
                  throw "Tailscale IP not assigned"
              }
              
              echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
              Write-Host "‚úÖ Connected to Tailscale at IP: $tsIP" -ForegroundColor Green
              
          } catch {
              Write-Error "Tailscale connection failed: $_"
              exit 1
          }

      - name: üõ°Ô∏è Show Connection Info
        run: |
          try {
              Write-Host "üõ°Ô∏è Verifying RDP accessibility..." -ForegroundColor Cyan
              
              $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue
              if (-not $testResult.TcpTestSucceeded) {
                  throw "Cannot establish RDP connection"
              }
              
              # Clear and show banner
              Clear-Host
              Write-Host ""
              Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
              Write-Host "‚ïë                    üîê UNLIMITED RDP ACCESS                       ‚ïë" -ForegroundColor Cyan
              Write-Host "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" -ForegroundColor Cyan
              Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
              Write-Host "  üÜî Session ID    : $env:GITHUB_RUN_ID" -ForegroundColor White
              Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
              Write-Host "  üåê RDP Address   : $env:TAILSCALE_IP:3389" -ForegroundColor Green
              Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
              Write-Host "  üë§ Username      : $env:RDP_USERNAME" -ForegroundColor Yellow
              Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
              Write-Host "  üîë Password      : $env:RDP_PASSWORD" -ForegroundColor Red
              Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
              Write-Host "  ‚è∞ Started       : $env:RDP_TIMESTAMP" -ForegroundColor Gray
              Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
              Write-Host "  ‚ôæÔ∏è  Mode          : UNLIMITED (jalan terus)" -ForegroundColor Magenta
              Write-Host "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" -ForegroundColor Cyan
              Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
              Write-Host "  üìù QUICK CONNECT: mstsc /v:$env:TAILSCALE_IP:3389" -ForegroundColor White
              Write-Host "‚ïë" -ForegroundColor Cyan -NoNewline
              Write-Host "  üõë STOP SESSION : Cancel job di GitHub Actions" -ForegroundColor Red
              Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan
              Write-Host ""
              
          } catch {
              Write-Error "Connection verification failed: $_"
              exit 1
          }

      - name: üîÑ UNLIMITED Mode - Keep Alive Forever
        run: |
          Write-Host ""
          Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Green
          Write-Host "‚ïë        üöÄ UNLIMITED MODE AKTIF - JALAN TERUS üöÄ           ‚ïë" -ForegroundColor Green
          Write-Host "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" -ForegroundColor Green
          Write-Host "‚ïë" -ForegroundColor Green -NoNewline
          Write-Host "  üìç RDP IP      : $env:TAILSCALE_IP:3389" -ForegroundColor White
          Write-Host "‚ïë" -ForegroundColor Green -NoNewline
          Write-Host "  üë§ Username    : $env:RDP_USERNAME" -ForegroundColor Yellow
          Write-Host "‚ïë" -ForegroundColor Green -NoNewline
          Write-Host "  üîë Password    : $env:RDP_PASSWORD" -ForegroundColor Red
          Write-Host "‚ïë" -ForegroundColor Green -NoNewline
          Write-Host "  üõë Cara stop   : Klik 'Cancel workflow' di GitHub" -ForegroundColor Red
          Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Green
          Write-Host ""
          
          $heartbeatCount = 0
          $reconnectCount = 0
          
          while ($true) {
              try {
                  $heartbeatCount++
                  
                  # Check connection every 30 seconds
                  if ($heartbeatCount % 6 -eq 0) {  # Every 3 minutes
                      $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue
                      
                      if (-not $testResult.TcpTestSucceeded) {
                          $reconnectCount++
                          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ‚ö†Ô∏è Koneksi terputus! Mencoba reconnect... ($reconnectCount)" -ForegroundColor Yellow
                          
                          # Try to reconnect Tailscale
                          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="$env:TAILSCALE_APP_NAME-$env:GITHUB_RUN_ID-reconnect" 2>$null
                          
                          # Restart RDP service
                          Restart-Service -Name TermService -Force 2>$null
                          
                          Start-Sleep -Seconds 10
                      }
                  }
                  
                  # Normal heartbeat - show every 60 seconds
                  if ($heartbeatCount % 2 -eq 0) {  # Every minute
                      Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ‚ù§Ô∏è RDP Active - IP: $env:TAILSCALE_IP | Reconnects: $reconnectCount" -ForegroundColor Green
                  }
                  
                  Start-Sleep -Seconds 30
                  
              } catch {
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ‚ö†Ô∏è Error in monitor: $_" -ForegroundColor Red
                  Start-Sleep -Seconds 60
              }
          }
